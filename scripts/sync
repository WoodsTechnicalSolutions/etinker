#!/bin/bash
#

usage()
{
	printf "USAGE: sync <target> <destination>\n"
	printf "       sync <bootloader|kernel|rootfs|overlay> mmc\n"
	printf "       sync <bootloader|kernel|rootfs>         net:<ipv4-address>\n"
}

wait_on_sync()
{
	printf "[%s][%s] waiting on %s filesystem 'sync' ... " $1 $2 $3
	sudo sync
	printf "[done]\n"
}

if ! [ -n "${2}" ]; then
	printf "Missing sync destination!\n"
	usage
	exit 1
fi

destination=${2}

if ! [ -n "${1}" ]; then
	printf "Missing sync build target!\n"
	usage
	exit 1
fi

target=${1}

case "${target}" in
	bootloader)
		target_dir="${ET_BOOTLOADER_DIR}"
		;;
	kernel)
		target_dir="${ET_KERNEL_DIR}"
		;;
	overlay)
		target_dir="${ET_OVERLAY_DIR}"
		;;
	rootfs)
		target_dir="${ET_ROOTFS_DIR}"
		;;
	*)
		printf "Unsupported build target! [%s]\n" ${target}
		exit 1
		;;
esac

if ! [ -d ${target_dir} ]; then
	printf "Target directory does not exist! [%s]\n" ${target_dir}
	usage
	exit 1
fi

if [ -z "${ET_IFACE}" ]; then
	net_if="`ip route | grep -m 1 default | cut -d ' ' -f 5`"
else
	net_if="${ET_IFACE}"
fi
net_addr="`ip addr show ${net_if} | grep 'inet ' | cut -d '/' -f 1 | cut -d ' ' -f 6`"

printf "[%s][%s] Synching to %s has started.\n" ${ET_BOARD} ${target} ${destination}

case "${destination}" in
	mmc)
		if [ -d /media/$USER ]; then
			# Ubuntu media location
			media="/media/$USER"
		else
			if [ -d /run/media/$USER ]; then
				# Arch Linux media location
				media="/run/media/$USER"
			else
				printf "Unknown SD/MMC media directory location!\n"
				exit 1
			fi
		fi
		if ! [ -d ${media}/rootfs ]; then
			printf "Unmounted media directory! [%s/rootfs]\n" ${media}
			exit 1
		fi
		printf "[%s][%s] populating %s data.\n" ${ET_BOARD} ${target} ${destination}
		case "${target}" in
			kernel|bootloader)
				if ! [ -d ${media}/BOOT ]; then
					printf "Unmounted media directory! [%s/BOOT]\n" ${media}
					exit 1
				fi
				sudo mkdir -p ${media}/rootfs/lib/firmware
				sudo rsync -aP ${target_dir}/* ${media}/rootfs/
				if [ "${target}" = "kernel" ]; then
					sudo rsync -aP  ${target_dir}/../../../firmware/* ${media}/rootfs/lib/firmware/
				fi
				sudo rsync -P  ${target_dir}/boot/* ${media}/BOOT/

				if [ "${target}" = "bootloader" ]; then
					printf "[%s][%s] writing raw %s data.\n" ${ET_BOARD} ${target} ${destination}
				fi

				blkdev="`df ${media}/BOOT | tail -1 | cut -d ' ' -f 1 | cut -d 1 -f 1 | tr -d \\n`"
				case "${ET_BOARD_TYPE}" in
					meson)
						printf "\n*** write ${ET_BOOTLOADER_DIR}/boot/u-boot.bin.sd.bin to ${blkdev} ***\n\n"
						sudo dd if=${ET_BOOTLOADER_DIR}/boot/u-boot.bin.sd.bin of=${blkdev} conv=fsync,notrunc bs=1 count=444
						sudo dd if=${ET_BOOTLOADER_DIR}/boot/u-boot.bin.sd.bin of=${blkdev} conv=fsync,notrunc bs=512 skip=1 seek=1
						;;
					layerscape)
						printf "\n*** zero 4 MiB of ${blkdev} @ 8 block offset ***\n\n"
						sudo dd if=/dev/zero of=${blkdev} conv=fsync,notrunc bs=512 seek=8 count=8192
						printf "\n*** write BL2 image to ${blkdev} @ 8 block offset ***\n\n"
						sudo dd if=${ET_BOOTLOADER_DIR}/boot/bl2_sd.pbl of=${blkdev} conv=fsync,notrunc bs=512 seek=8
						printf "\n*** write FIP image to ${blkdev} @ 2048 block offset ***\n\n"
						sudo dd if=${ET_BOOTLOADER_DIR}/boot/fip.bin of=${blkdev} conv=fsync,notrunc bs=512 seek=2048
						;;
					*)
						# NOOP
						;;
				esac
				;;
			overlay)
				sudo rsync --exclude-from=${ET_OVERLAY_DIR}/exclude \
					-aP ${target_dir}/* \
					${media}/rootfs/
				;;
			rootfs)
				if [ -n "`ls ${media}/rootfs/`" ]; then
					if ! [ "`ls ${media}/rootfs/`" = "lost+found" ]; then
						printf "non-empty rootfs detected! [ ${media}/rootfs ]\n"
						exit 1
					fi
				fi
				sudo tar -xf ${target_dir}/images/rootfs.tar -C ${media}/rootfs/
				;;
			*)
				printf "Target '%s' is unsupported for '%s'!\n" ${target} ${destination}
				exit 1
				;;
		esac
		wait_on_sync ${ET_BOARD} ${target} ${destination}
		;;
	net:*)
		ipv4="`printf ${destination} | cut -d ':' -f 2`"
		printf "[%s][%s] Using %s [%s] -> %s\n" ${ET_BOARD} ${target} ${net_if} ${net_addr} ${ipv4}
		case "${target}" in
			kernel|bootloader)
				rsync -e "ssh -o BindAddress=${net_addr} -o LogLevel=quiet -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no" \
					-aP ${target_dir}/* \
					root@${ipv4}:/ 2> /dev/null
				if [ "${target}" = "kernel" ]; then
					rsync -e 'ssh -o BindAddress=${net_addr} -o LogLevel=quiet -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no' \
						-aP ${target_dir}/../../../firmware/* \
						root@${ipv4}:/lib/firmware/ 2> /dev/null
				fi
				rsync -e "ssh -o BindAddress=${net_addr} -o LogLevel=quiet -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no" \
					-P ${target_dir}/boot/* \
					root@${ipv4}:/media/BOOT/ 2> /dev/null
				;;
			overlay)
				rsync -e "ssh -o BindAddress=${net_addr} -o LogLevel=quiet -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no" \
					--exclude-from=${target_dir}/exclude \
					-aP ${target_dir}/* \
					root@${ipv4}:/ 2> /dev/null
				;;
			rootfs)
				if ! [ "`printf ${ET_ROOTFS_TYPE}|grep -Po meson`" = "meson" ]; then
					printf "Synching '%s' is unsupported for '%s'\n" ${target} ${ET_ROOTFS_TYPE}
					exit 0
				fi
				rsync -e "ssh -o BindAddress=${net_addr} -o LogLevel=quiet -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no" \
					-aP ${target_dir}/images/rootfs.tar \
					root@${ipv4}:/media/data/ 2> /dev/null
				rsync -e "ssh -o BindAddress=${net_addr} -o LogLevel=quiet -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no" \
					-aP ${target_dir}/../../../common/rootfs/* \
					root@${ipv4}:/ 2> /dev/null
				;;
			*)
				printf "Target '%s' is unsupported for '%s'!\n" ${target} ${destination}
				exit 1
				;;
		esac
		;;
	*)
		printf "Sync destination [%s] not implemented!\n" ${destination}
		usage
		exit 1
esac

printf "[%s][%s] Synching to %s has completed.\n" ${ET_BOARD} ${target} ${destination}
